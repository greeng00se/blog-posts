> Joshua Bloch님의 Effective Java 3/E를 읽고 정리한 글입니다.
> 

## 가능한 한 실패 원자적으로 만들라

- 실패 원자적이란 무엇이고 어떻게 하면 실패 원자적 메서드를 구현할 수 있을까?

### 실패 원자적(failure-atomic)

- 호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태를 유지하는 것이다.

### 메서드를 실패 원자적으로 만드는 방법

- 불변 객체를 사용하는 방법
    - 태생이 실패 원자적이다.
    - 실패하더라도 기존 객체가 불안정한 상태로 변하지 않는다.
- 가변 객체를 사용하는 경우 유효성을 검사하는 방법
    - 작업 수행에 앞서 매개변수의 유효성을 검사하면 실패 원자적으로 만들 수 있다.
    - 객체의 내부 상태를 변경하는 코드보다 검사를 하는 코드를 앞에 배치한다.
- 임시 복사본에서 작업을 수행하는 방법
    - 복사본에서 작업을 수행하고 작업이 완료되면 원래 객체와 교체한다.
- 작업 도중 발생하는 실패를 가로채는 복구 코드를 작성하여 작업 전 상태로 되돌리는 방법
    - 주로 디스크 기반의 내구성을 보장해야 하는 자료구조에 사용된다.

### 실패 원자적으로 만들 때 주의사항

- 항상 실패 원자적으로 만들 수 있는 것은 아니다.
    - 두 스레드가 동기화 없이 같은 객체를 동시에 수정한다면 객체의 일관성이 깨질 수도 있다.
- `Error`는 복구할 수 없으므로 `AssertionError`에 대해서는 실패 원자적으로 만들려고 할 필요가 없다.
- 실패 원자성을 달성하기 위한 비용이나 복잡도가 큰 경우 시도 전 고려를 해야 한다.

## 정리

- 실패 원자적이란 메서드가 정상적으로 종료되지 않더라도 호출 전 상태를 유지하는 것이다.
- 실패 원자적으로 메서드를 만드는 것은 권장되는 방법이지만 실패 원자적으로 만들 수 없는 경우도 존재한다.
- 실패 원자적으로 만들 수 없는 경우 API 설명에 명시해야 한다.